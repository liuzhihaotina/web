<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metrics Heatmaps</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Font Awesomeï¼ˆæ‚¨ä»£ç ä¸­å·²ä½¿ç”¨ï¼‰ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- user -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

</head>
<body>
  <div class="page">
    <header class="header">
      <div>
        <h1>ğŸ“Š æŒ‡æ ‡çƒ­åŠ›å›¾æ€»è§ˆï¼ˆæŒ‰æŒ‡æ ‡çºµå‘æ’åˆ—ï¼‰</h1>
        <div class="sub">
          âœ…åº•éƒ¨å­æŒ‡æ ‡ï¼šæ–œä½“åâ€œæœ«å°¾æ°´å¹³å¯¹é½â€ï¼ˆæœ€åä¸€ä¸ªå­—ç¬¦å¯¹é½ï¼‰ï¼›
          âœ…å°½å¯èƒ½è´´è¿‘çƒ­åŠ›å›¾ä¸”ä¸é®æŒ¡ï¼›
          âœ…æ¯åˆ—åˆ—å®½è‡ªé€‚åº”ï¼›ä»…ä¸­é—´æ¨ªå‘æ»šåŠ¨ï¼›å·¦ä¾§å›ºå®šï¼›å³ä¾§å›¾ä¾‹å›ºå®šï¼›åˆ—å†…å½’ä¸€åŒ–ä¸Šè‰²
        </div>
      </div>
    </header>

    {% if error %}
      <div class="alert">{{ error }}</div>
    {% endif %}

    <section class="panel">
      <form method="get" class="form">
        <div class="row">
          <label>æœç´¢</label>
          <input type="text" name="keyword" value="{{ keyword }}" />
        </div>

        <div class="grid">
          <div class="col">
            <label>æ¨¡å‹ï¼ˆæ¥è‡ªå­æ–‡ä»¶å¤¹åï¼‰</label>
            <select name="models" multiple size="8">
              {% for m in models_all %}
                <option value="{{ m }}" {% if m in selected_models %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
            <div class="hint">æŒ‰ä½ Ctrl/Command å¤šé€‰</div>
          </div>

          <div class="col">
            <label>æŒ‡æ ‡ï¼ˆæ¥è‡ª json æ–‡ä»¶åï¼‰</label>
            <select name="metrics" multiple size="8">
              {% for mt in metrics_all %}
                <option value="{{ mt }}" {% if mt in selected_metrics %}selected{% endif %}>{{ mt }}</option>
              {% endfor %}
            </select>
            <div class="hint">ä¸é€‰æ—¶é»˜è®¤å±•ç¤ºå…¨éƒ¨</div>
          </div>

          <div class="col">
            <!-- <label>æ˜¾ç¤º/æ ·å¼</label>

            <div class="check">
              <input id="show_text" type="checkbox" name="show_text" value="1" {% if settings.show_text %}checked{% endif %}>
              <label for="show_text">æ¯ä¸ªæ ¼å­æ˜¾ç¤ºæ•°å€¼ï¼ˆåŸå§‹å€¼ï¼‰</label>
            </div>

            <div class="row">
              <label>å°æ•°ä½</label>
              <input type="number" min="0" max="8" name="precision" value="{{ settings.precision }}" />
            </div>

            <div class="check">
              <input id="robust" type="checkbox" name="robust" value="1" {% if settings.robust %}checked{% endif %}>
              <label for="robust">åˆ—èŒƒå›´ç”¨ç¨³å¥åˆ†ä½ï¼ˆ2%~98%ï¼‰</label>
            </div> -->

            <div class="dropdown">
                <button type="button" class="btn dropdown-toggle" 
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ruler-vertical"></i> é«˜åº¦é˜ˆå€¼ {{ height }}
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" href="#" id="height-btn4">
                            <i class="fas fa-sort-amount-up"></i> 0.625
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" id="height-btn3">
                            <i class="fas fa-arrow-up"></i> 0.325
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" id="height-btn2">
                            <i class="fas fa-arrow-right"></i> 0
                        </a>
                    </li>
                    
                    <li>
                        <a class="dropdown-item" href="#" id="height-btn1">
                            <i class="fas fa-sort-amount-down"></i> -1
                        </a>
                    </li>
                </ul>
            </div>
            <input type="hidden" name="height" id="height-hidden" value="{{ height|default(-1, true) }}">

            <!-- æ–°å¢ï¼šOcc Threshold æ»‘åŠ¨æ¡ -->
            <label for="occ-threshold-slider" class="form-label">Occ Threshold</label>
            <input type="range" class="form-range" id="occ-threshold-slider" min="0.5" max="0.7" step="0.02" value="{{ occ_threshold|default(0.60, true) }}">
            <span id="occ-threshold-value">{{ occ_threshold }}</span> <!-- æ˜¾ç¤ºæ»‘åŠ¨æ¡çš„å½“å‰å€¼ -->
            <!-- å…³é”®ï¼šéšè—å­—æ®µï¼Œè®©è¡¨å•æäº¤æ—¶å¸¦ä¸Šå‚æ•° -->
            <input
            type="hidden"
            name="occ_threshold"
            id="occ-threshold-hidden"
            value="{{ occ_threshold|default(0.60, true) }}"
            >

            <button class="btn" type="submit">åˆ·æ–°å±•ç¤º</button>
            <!-- <button id="searchBtn">æœç´¢</button> -->
          </div>
        </div>
      </form>
    </section>

    <main class="charts">
      {% for c in charts %}
        <section class="chart-block">
          {% if c.empty %}
            <div class="warn">æŒ‡æ ‡ <b>{{ c.metric }}</b>ï¼šæ²¡æœ‰ä»»ä½•æ¨¡å‹åŒ…å«è¯¥æŒ‡æ ‡ jsonï¼Œæˆ– json å†…æ— å¯è§£ææ•°å€¼ã€‚</div>
          {% else %}
            <div class="hm-row" style="height: {{ c.height }}px;">
              <div class="yaxis-pane" style="width: {{ c.yaxis_width }}px;">
                {% for y in c.y %}
                  <div class="yaxis-item" style="height: {{ constants.CELL_H_PX }}px;" title="{{ y }}">{{ y }}</div>
                {% endfor %}
                <div class="yaxis-footer-spacer" style="height: {{ c.footer_h }}px;"></div>
              </div>

              <div class="matrix-scroll">
                <div class="matrix-pane" style="min-width: {{ c.min_matrix_width }}px;">
                  <table class="hm-table">
                    <colgroup>
                      {% for w in c.col_widths %}
                        <col style="width: {{ w }}px;" />
                      {% endfor %}
                    </colgroup>

                    <tbody>
                      {% for i in range(c.y|length) %}
                        <tr>
                          {% for j in range(c.x|length) %}
                            {% set rel = c.z[i][j] %}
                            {% set raw = c.customdata[i][j][0] %}
                            {% set cmin = c.customdata[i][j][1] %}
                            {% set cmax = c.customdata[i][j][2] %}
                            <td class="cell"
                                data-rel="{{ rel }}"
                                title="Model={{ c.y[i] }}&#10;Submetric={{ c.x[j] }}&#10;Raw={{ raw }}&#10;ColRange=[{{ cmin }}, {{ cmax }}]&#10;Rel(0~1)={{ rel }}">
                              <span class="cell-text">{% if c.text %}{{ c.text[i][j] }}{% endif %}</span>
                            </td>
                          {% endfor %}
                        </tr>
                      {% endfor %}

                      <tr class="xfooter" style="height: {{ c.footer_h }}px;">
                        {% for x in c.x %}
                          <td class="xcell" title="{{ x }}">
                            <span class="xcell-text">{{ x }}</span>
                          </td>
                        {% endfor %}
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="cbar-pane" style="width: {{ constants.CBAR_WIDTH }}px;">
                <div class="legend-wrap" style="height: {{ c.height }}px;">
                  <div class="legend" data-target="{{ c.legend_target }}">
                    <div class="legend-title">åˆ—å†…ç›¸å¯¹</div>
                    <div class="legend-bar"></div>
                    <div class="legend-ticks">
                      <div class="tick">é«˜</div>
                      <div class="tick">ä¸­</div>
                      <div class="tick">ä½</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <div class="metric-label">{{ c.metric }}</div>
        </section>
      {% endfor %}
    </main>
  </div>
    <!-- jQueryï¼ˆBootstrap 5å¯é€‰ï¼Œä½†å»ºè®®æ·»åŠ ï¼‰ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ä¸»JavaScriptæ–‡ä»¶ -->
    <script>
        const COLORFUL = [
        [0.00, "#30123b"],
        [0.10, "#3b4cc0"],
        [0.20, "#2c7ef7"],
        [0.30, "#1fb3ff"],
        [0.40, "#28e2d9"],
        [0.50, "#52fa7b"],
        [0.60, "#b6f53c"],
        [0.70, "#f4e61e"],
        [0.80, "#fca50a"],
        [0.90, "#f05b11"],
        [1.00, "#7a0403"],
        ];
        
        const DETAILED_GOR = [
            // [0.00, "#716464"], 
            [0.0, "#303030"],
            [0.10, "#3f3f3f"],
            [0.15, "#4e4e4e"],
            [0.20, "#5d5d5d"],
            [0.25, "#6d4a2a"],  // å¼€å§‹å¸¦æ©™è‰²
            [0.30, "#7d552f"],
            [0.35, "#8d6135"],
            [0.40, "#9d6c3a"],  // æ©™æ£•
            [0.45, "#ad7840"],
            [0.50, "#bd8345"],  // ä¸­ç­‰æ©™
            [0.55, "#cd8f4b"],
            [0.60, "#dd9a50"],  // æ©™è‰²
            [0.65, "#eda655"],
            [0.70, "#fda15a"],  // äº®æ©™
            [0.75, "#ff8c4d"],  // æ©™çº¢è¿‡æ¸¡
            [0.80, "#ff7740"],  // çº¢æ©™
            [0.85, "#d6452d"],  // æ©™çº¢
            [0.90, "#d6452d"],  // çº¢
            [0.95, "#b21b1b"],  // äº®çº¢
            [1.00, "#7f0b0b"],  // é²œçº¢
        ];

        const TURBO1 = [
            [0.00, "#99826e"],
            [0.12, "#b3977f"],
            [0.24, "#c6a487"],
            [0.36, "#d8ae8a"],
            [0.48, "#f3c298"],
            [0.60, "#f19953"],
            [0.72, "#e96b2c"],
            [0.84, "#d6452d"],
            [0.92, "#b21b1b"],
            [1.00, "#7f0b0b"]
        ];

        const TURBO = DETAILED_GOR;
        let keyword_ = "{{ keyword }}";

        function hexToRgb(h) {
            const x = h.replace("#","").trim();
            const n = parseInt(x, 16);
            return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
        }
        function lerp(a,b,t){ return a + (b-a)*t; }

        function turboColor(t) {
            if (t == null || Number.isNaN(t)) return "rgba(0,0,0,0)";
            t = Math.max(0, Math.min(1, t));
            for (let i=0; i<TURBO.length-1; i++){
                const [t0,c0] = TURBO[i];
                const [t1,c1] = TURBO[i+1];
                if (t >= t0 && t <= t1){
                const u = (t - t0) / (t1 - t0 + 1e-12);
                const a = hexToRgb(c0), b = hexToRgb(c1);
                const r = Math.round(lerp(a.r,b.r,u));
                const g = Math.round(lerp(a.g,b.g,u));
                const bb = Math.round(lerp(a.b,b.b,u));
                return `rgb(${r},${g},${bb})`;
                }
            }
            return TURBO[TURBO.length-1][1];
        }

        function paintAllCells(){
            document.querySelectorAll("td.cell").forEach(td=>{
                const rel = parseFloat(td.dataset.rel);
                td.style.background = Number.isNaN(rel) ? "rgba(255,255,255,0.02)" : turboColor(rel);
            });
        }

        function setupLegends(){
            document.querySelectorAll(".legend").forEach(el=>{
                const targetH = parseFloat(el.dataset.target);
                const bar = el.querySelector(".legend-bar");
                const ticks = el.querySelector(".legend-ticks");
                const stops = TURBO.map(([t,c]) => `${c} ${Math.round(t*100)}%`).join(", ");
                bar.style.background = `linear-gradient(to top, ${stops})`;
                bar.style.height = `${targetH}px`;
                ticks.style.height = `${targetH}px`;
            });
        }

        paintAllCells();
        setupLegends();
// ------------------------------------é«˜åº¦é˜ˆå€¼â†“-------------------------------------------
        // å®šä¹‰å­˜å‚¨é«˜åº¦é˜ˆå€¼çš„å˜é‡
        let selectedHeightThreshold = null;

        // åˆå§‹åŒ–æ‰€æœ‰é«˜åº¦é˜ˆå€¼æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        function initHeightThresholdButtons() {
            // ä¸ºæ¯ä¸ªé«˜åº¦é˜ˆå€¼æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.getElementById('height-btn1').addEventListener('click', function(e) {
                e.preventDefault();
                selectHeightThreshold(-1, 'height-btn1');
            });
            
            document.getElementById('height-btn2').addEventListener('click', function(e) {
                e.preventDefault();
                selectHeightThreshold(0, 'height-btn2');
            });
            
            document.getElementById('height-btn3').addEventListener('click', function(e) {
                e.preventDefault();
                selectHeightThreshold(0.325, 'height-btn3');
            });
            
            document.getElementById('height-btn4').addEventListener('click', function(e) {
                e.preventDefault();
                selectHeightThreshold(0.625, 'height-btn4');
            });
        }
        function selectHeightThreshold(value, buttonId) {
            selectedHeightThreshold = value;

            // 2. æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
            const dropdownButton = document.querySelector('.dropdown-toggle');
            // âœ… å…ˆæ›´æ–° UIï¼ˆä»¥åŠ hiddenï¼‰
            applyHeightUI(String(value));
            
            // 4. å…³é—­ä¸‹æ‹‰èœå•ï¼ˆå¦‚æœä½¿ç”¨Bootstrapï¼‰
            const dropdownMenu = document.querySelector('.dropdown-menu');
            if (dropdownMenu) {
                const bsDropdown = bootstrap.Dropdown.getInstance(dropdownButton);
                if (bsDropdown) {
                    bsDropdown.hide();
                }
            }

            const occ = document.getElementById('occ-threshold-hidden')?.value
                    || document.getElementById('occ-threshold-slider')?.value
                    || '0.60';

            window.location.href =
                `/?height=${encodeURIComponent(value)}&keyword=${encodeURIComponent(keyword_)}&occ_threshold=${encodeURIComponent(occ)}`;
        }

        // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
        function removeAllActiveClasses() {
            const items = document.querySelectorAll('.dropdown-item');
            items.forEach(item => {
                item.classList.remove('active');
            });
        }

        function applyHeightUI(value) {
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const dropdownButton = document.querySelector('.dropdown-toggle');
            if (dropdownButton) {
                const icon = dropdownButton.querySelector('i')?.cloneNode(true);
                dropdownButton.innerHTML = '';
                if (icon) dropdownButton.appendChild(icon);
                dropdownButton.appendChild(document.createTextNode(` é«˜åº¦é˜ˆå€¼: ${value}`));
            }

            // é«˜äº®é€‰ä¸­é¡¹
            removeAllActiveClasses();
            const map = {
                "-1": "height-btn1",
                "0": "height-btn2",
                "0.325": "height-btn3",
                "0.625": "height-btn4",
            };
            const key = String(value);
            if (map[key]) document.getElementById(map[key])?.classList.add('active');

            // åŒæ­¥éšè—å­—æ®µï¼ˆå¦‚æœä½ åŠ äº† height-hiddenï¼‰
            const hh = document.getElementById('height-hidden');
            if (hh) hh.value = value;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initHeightThresholdButtons();

            // âœ… ä¼˜å…ˆä» URL è¯» height
            const qs = new URLSearchParams(window.location.search);
            const hFromUrl = qs.get('height');

            if (hFromUrl !== null) {
                // ç»Ÿä¸€æˆ number/å­—ç¬¦ä¸²éƒ½è¡Œï¼Œåªè¦è·Ÿ map çš„ key èƒ½å¯¹ä¸Š
                const h = Number(hFromUrl);
                // å¤„ç† -1,0,0.325,0.625 è¿™ç§ç²¾ç¡®å€¼ï¼šç”¨åŸå­—ç¬¦ä¸²æ›´ç¨³
                applyHeightUI(hFromUrl);  // æ¨èï¼šç›´æ¥ç”¨å­—ç¬¦ä¸²
            } else {
                // URL æ²¡æœ‰å°±ç”¨æ¨¡æ¿æ¸²æŸ“å€¼ï¼ˆä½œä¸ºå…œåº•ï¼‰
                applyHeightUI("{{ height|default(0, true) }}");
            }
        });
// ------------------------------------é«˜åº¦é˜ˆå€¼â†‘-------------------------------------------

// ------------------------------------Occ Threshold æ»‘åŠ¨æ¡â†“-------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
        const slider = document.getElementById('occ-threshold-slider');
        const valueEl = document.getElementById('occ-threshold-value');
        const hidden = document.getElementById('occ-threshold-hidden');

        const qs = new URLSearchParams(window.location.search);
        const fromUrl = qs.get('occ_threshold');

        const initVal = Number(fromUrl ?? slider.value ?? 0.6).toFixed(2);
        slider.value = initVal;
        valueEl.textContent = initVal;
        hidden.value = initVal;

        slider.addEventListener('input', () => {
            const v = Number(slider.value).toFixed(2);
            valueEl.textContent = v;
            hidden.value = v;
        });
        });
// ------------------------------------Occ Threshold æ»‘åŠ¨æ¡â†‘-------------------------------------------
        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        // document.getElementById('searchBtn').addEventListener('click', function() {
        //     console.log('keyword', keyword_);
        //     fetch(`/?keyword=${keyword_}`)
        //         .catch(error => {
        //             console.error('è¯·æ±‚å¤±è´¥:', error);
        //             alert('è¯·æ±‚å¤±è´¥: ' + error.message);
        //         });
        // });
    </script>
</body>
</html>