<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metrics Heatmaps</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>

<body>
  <div class="page">
    <header class="header">
      <div>
        <h1>ğŸ“Š æŒ‡æ ‡çƒ­åŠ›å›¾æ€»è§ˆï¼ˆæŒ‰æŒ‡æ ‡çºµå‘æ’åˆ—ï¼‰</h1>
        <div class="sub">
          âœ…åº•éƒ¨å­æŒ‡æ ‡ï¼šæ–œä½“åâ€œæœ«å°¾æ°´å¹³å¯¹é½â€ï¼ˆæœ€åä¸€ä¸ªå­—ç¬¦å¯¹é½ï¼‰ï¼›
          âœ…å°½å¯èƒ½è´´è¿‘çƒ­åŠ›å›¾ä¸”ä¸é®æŒ¡ï¼›
          âœ…æ¯åˆ—åˆ—å®½è‡ªé€‚åº”ï¼›ä»…ä¸­é—´æ¨ªå‘æ»šåŠ¨ï¼›å·¦ä¾§å›ºå®šï¼›å³ä¾§å›¾ä¾‹å›ºå®šï¼›åˆ—å†…å½’ä¸€åŒ–ä¸Šè‰²
        </div>
      </div>
    </header>

    {% if error %}
      <div class="alert">{{ error }}</div>
    {% endif %}

    <section class="panel">
      <form method="get" class="form">
        <div class="row">
          <label>æœç´¢</label>
          <input type="text" name="keyword" value="{{ keyword }}" />
        </div>

        <div class="grid">
          <div class="col">
            <label>æ¨¡å‹ï¼ˆæ¥è‡ªå­æ–‡ä»¶å¤¹åï¼‰</label>
            <select name="models" multiple size="8">
              {% for m in models_all %}
                <option value="{{ m }}" {% if m in selected_models %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
            <div class="hint">æŒ‰ä½ Ctrl/Command å¤šé€‰</div>
          </div>

          <div class="col">
            <label>æŒ‡æ ‡ï¼ˆæ¥è‡ª json æ–‡ä»¶åï¼‰</label>
            <select name="metrics" multiple size="8">
              {% for mt in metrics_all %}
                <option value="{{ mt }}" {% if mt in selected_metrics %}selected{% endif %}>{{ mt }}</option>
              {% endfor %}
            </select>
            <div class="hint">ä¸é€‰æ—¶é»˜è®¤å±•ç¤ºå…¨éƒ¨</div>
          </div>

          <div class="col">
            <div class="dropdown">
              <button type="button" class="btn dropdown-toggle"
                      data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-ruler-vertical"></i> é«˜åº¦é˜ˆå€¼ {{ height }}
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="height-btn4"><i class="fas fa-sort-amount-up"></i> 0.625</a></li>
                <li><a class="dropdown-item" href="#" id="height-btn3"><i class="fas fa-arrow-up"></i> 0.325</a></li>
                <li><a class="dropdown-item" href="#" id="height-btn2"><i class="fas fa-arrow-right"></i> 0</a></li>
                <li><a class="dropdown-item" href="#" id="height-btn1"><i class="fas fa-sort-amount-down"></i> -1</a></li>
              </ul>
            </div>
            <input type="hidden" name="height" id="height-hidden" value="{{ height|default(-1, true) }}">

            <label for="occ-threshold-slider" class="form-label">Occ Threshold</label>
            <div class="range-wrap">
              <input type="range" class="form-range" id="occ-threshold-slider"
                     min="0.5" max="0.7" step="0.02"
                     value="{{ occ_threshold|default(0.60, true) }}">

              <div id="occ-threshold-midvalue">
                {{ occ_threshold|default(0.60, true) }}
              </div>

              <div class="range-labels">
                <span>0.5</span>
                <span>0.7</span>
              </div>
            </div>

            <input type="hidden" name="occ_threshold" id="occ-threshold-hidden"
                   value="{{ occ_threshold|default(0.60, true) }}">

            <button class="btn" type="submit">åˆ·æ–°å±•ç¤º</button>
          </div>
        </div>
      </form>
    </section>

    <main class="charts">
      {% for c in charts %}
        <section class="chart-block">
          {% if c.empty %}
            <div class="warn">æŒ‡æ ‡ <b>{{ c.metric }}</b>ï¼šæ²¡æœ‰ä»»ä½•æ¨¡å‹åŒ…å«è¯¥æŒ‡æ ‡ jsonï¼Œæˆ– json å†…æ— å¯è§£ææ•°å€¼ã€‚</div>
          {% else %}
            <div class="hm-row" style="height: {{ c.height }}px;">
              <div class="yaxis-pane" style="width: {{ c.yaxis_width }}px;">
                {% for y in c.y %}
                  <div class="yaxis-item" style="height: {{ constants.CELL_H_PX }}px;" title="{{ y }}">{{ y }}</div>
                {% endfor %}
                <div class="yaxis-footer-spacer" style="height: {{ c.footer_h }}px;"></div>
              </div>

              <div class="matrix-scroll">
                <div class="matrix-pane" style="min-width: {{ c.min_matrix_width }}px;">
                  <table class="hm-table">
                    <colgroup>
                      {% for w in c.col_widths %}
                        <col style="width: {{ w }}px;" />
                      {% endfor %}
                    </colgroup>

                    <tbody>
                      {% for i in range(c.y|length) %}
                        <tr>
                          {% for j in range(c.x|length) %}
                            {% set rel = c.z[i][j] %}
                            {% set raw = c.customdata[i][j][0] %}
                            {% set cmin = c.customdata[i][j][1] %}
                            {% set cmax = c.customdata[i][j][2] %}
                            <td class="cell"
                                data-rel="{{ rel }}"
                                data-metric="{{ c.metric }}"
                                data-x="{{ c.x[j] }}"
                                title="Model={{ c.y[i] }}&#10;Submetric={{ c.x[j] }}&#10;Raw={{ raw }}&#10;ColRange=[{{ cmin }}, {{ cmax }}]&#10;Rel(0~1)={{ rel }}">
                              <span class="cell-text">{% if c.text %}{{ c.text[i][j] }}{% endif %}</span>
                            </td>
                          {% endfor %}
                        </tr>
                      {% endfor %}

                      <tr class="xfooter" style="height: {{ c.footer_h }}px;">
                        {% for x in c.x %}
                          <td class="xcell" title="{{ x }}">
                            <span class="xcell-text">{{ x }}</span>
                          </td>
                        {% endfor %}
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- âœ… åŒå›¾ä¾‹ï¼šçº¢ + ç»¿ -->
              <div class="cbar-pane" style="width: {{ constants.CBAR_WIDTH }}px;">
                <div class="legend-wrap" style="height: {{ c.height }}px;">
                  <div class="legend legend-dual" data-target="{{ c.legend_target }}">
                    <div class="legend-title">åˆ—å†…ç›¸å¯¹</div>

                <div class="legend-bars">
                    <div class="legend-block">
                        <div class="legend-subtitle">çº¢</div>
                        <div class="legend-bar legend-bar-red"></div>
                    </div>

                    <div class="legend-block">
                        <div class="legend-subtitle">ç»¿</div>
                        <div class="legend-bar legend-bar-green"></div>
                    </div>

                    <div class="legend-ticks">
                        <div class="tick">é«˜</div>
                        <div class="tick">ä¸­</div>
                        <div class="tick">ä½</div>
                    </div>
                </div>

                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <div class="metric-label">{{ c.metric }}</div>
        </section>
      {% endfor %}
    </main>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ------------------------------------å•è‰²ç»¿â†“-------------------------------------------
    const MONO_GREEN = [
      [0.00, "#F0FFF4"],
      [0.10, "#DCFFE4"],
      [0.20, "#B8F5C6"],
      [0.30, "#94E8A8"],
      [0.40, "#70DB8A"],
      [0.50, "#4CCE6C"],
      [0.60, "#28C14E"],
      [0.70, "#20A040"],
      [0.80, "#187F32"],
      [0.90, "#105E24"],
      [1.00, "#083D16"]
    ];
    // ------------------------------------å•è‰²ç»¿â†‘-------------------------------------------

    // ------------------------------------å•è‰²çº¢â†“-------------------------------------------
    const MONO_RED = [
      [0.00, "#FFF0F0"],
      [0.10, "#FFE1E1"],
      [0.20, "#FFB8B8"],
      [0.30, "#FF8F8F"],
      [0.40, "#FF6666"],
      [0.50, "#FF3D3D"],
      [0.60, "#FF1414"],
      [0.70, "#CC0000"],
      [0.80, "#990000"],
      [0.90, "#880000"],
      [1.00, "#700000"]
    ];
    // ------------------------------------å•è‰²çº¢â†‘-------------------------------------------
    // âœ… è¿™é‡Œâ€œç¡¬ç¼–ç â€ï¼šæ¯ä¸ªæŒ‡æ ‡(metric)çš„æ¯ä¸ªå­æŒ‡æ ‡åˆ—(x)ç”¨çº¢è¿˜æ˜¯ç»¿
    const COLOR_RULES = {{ color_code | tojson | safe }};
    const defaultPalette = "RED"; // æ²¡é…ç½®å°±é»˜è®¤çº¢
    let keyword_ = "{{ keyword }}";

    function choosePalette(metric, xLabel) {
      const m = COLOR_RULES[metric];
      if (!m) return defaultPalette;
      return m[xLabel] || defaultPalette;
    }

    function paletteStops(name) {
      return (name === "GREEN") ? MONO_GREEN : MONO_RED;
    }

    function hexToRgb(h) {
      const x = h.replace("#","").trim();
      const n = parseInt(x, 16);
      return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
    }
    function lerp(a,b,t){ return a + (b-a)*t; }

    // âœ… é¢œè‰²å‡½æ•°æ”¯æŒä¼ å…¥ paletteï¼ˆçº¢/ç»¿ï¼‰
    function turboColor(t, paletteName) {
      const TURBO = paletteStops(paletteName);

      if (t == null || Number.isNaN(t)) return "rgba(0,0,0,0)";
      t = Math.max(0, Math.min(1, t));
      for (let i=0; i<TURBO.length-1; i++){
        const [t0,c0] = TURBO[i];
        const [t1,c1] = TURBO[i+1];
        if (t >= t0 && t <= t1){
          const u = (t - t0) / (t1 - t0 + 1e-12);
          const a = hexToRgb(c0), b = hexToRgb(c1);
          const r = Math.round(lerp(a.r,b.r,u));
          const g = Math.round(lerp(a.g,b.g,u));
          const bb = Math.round(lerp(a.b,b.b,u));
          return `rgb(${r},${g},${bb})`;
        }
      }
      return TURBO[TURBO.length-1][1];
    }

    function parseRgb(str) {
      const m = /^rgb\(\s*(\d+),\s*(\d+),\s*(\d+)\s*\)$/.exec(str);
      if (!m) return null;
      return { r: Number(m[1]), g: Number(m[2]), b: Number(m[3]) };
    }
    function luminance({ r, g, b }) {
      return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    // âœ… æ¯ä¸ªå•å…ƒæ ¼æ ¹æ® (metric, x) é€‰æ‹©çº¢/ç»¿æ¸å˜ï¼Œå¹¶è‡ªåŠ¨é»‘/ç™½å­—
    function paintAllCells(){
      document.querySelectorAll("td.cell").forEach(td=>{
        const rel = parseFloat(td.dataset.rel);
        const metric = td.dataset.metric || "";
        const x = td.dataset.x || "";
        const pal = choosePalette(metric, x);

        if (Number.isNaN(rel)) {
          td.style.background = "rgba(255,255,255,0.02)";
          td.style.color = "rgba(255,255,255,0.75)";
          return;
        }

        const bg = turboColor(rel, pal);
        td.style.background = bg;

        const rgb = parseRgb(bg);
        if (!rgb) {
          td.style.color = "#fff";
          return;
        }

        const L = luminance(rgb);
        td.style.color = (L > 150) ? "#000" : "#fff";
      });
    }

    // âœ… å›¾ä¾‹åŒæ—¶æ˜¾ç¤ºçº¢/ç»¿ä¸¤æ¡æ¸å˜
    function setupLegends(){
      document.querySelectorAll(".legend").forEach(el=>{
        const LEGEND_HEIGHT_SCALE = 0.75;  // 0.7 ~ 1.0 éƒ½å¯ä»¥è¯•
        const targetH = parseFloat(el.dataset.target) * LEGEND_HEIGHT_SCALE;


        const redBar = el.querySelector(".legend-bar-red");
        const greenBar = el.querySelector(".legend-bar-green");
        const ticks = el.querySelector(".legend-ticks");

        const redStops = MONO_RED.map(([t,c]) => `${c} ${Math.round(t*100)}%`).join(", ");
        const greenStops = MONO_GREEN.map(([t,c]) => `${c} ${Math.round(t*100)}%`).join(", ");



        if (redBar) {
          redBar.style.background = `linear-gradient(to top, ${redStops})`;
          redBar.style.height = `${targetH}px`;
        }
        if (greenBar) {
          greenBar.style.background = `linear-gradient(to top, ${greenStops})`;
          greenBar.style.height = `${targetH}px`;
        }
        if (ticks) {
          ticks.style.height = `${targetH}px`;
        }
      });
    }

    paintAllCells();
    setupLegends();

    // ------------------------------------é«˜åº¦é˜ˆå€¼â†“-------------------------------------------
    let selectedHeightThreshold = null;

    function initHeightThresholdButtons() {
      document.getElementById('height-btn1').addEventListener('click', function(e) {
        e.preventDefault();
        selectHeightThreshold(-1, 'height-btn1');
      });
      document.getElementById('height-btn2').addEventListener('click', function(e) {
        e.preventDefault();
        selectHeightThreshold(0, 'height-btn2');
      });
      document.getElementById('height-btn3').addEventListener('click', function(e) {
        e.preventDefault();
        selectHeightThreshold(0.325, 'height-btn3');
      });
      document.getElementById('height-btn4').addEventListener('click', function(e) {
        e.preventDefault();
        selectHeightThreshold(0.625, 'height-btn4');
      });
    }

    function removeAllActiveClasses() {
      const items = document.querySelectorAll('.dropdown-item');
      items.forEach(item => item.classList.remove('active'));
    }

    function applyHeightUI(value) {
      const dropdownButton = document.querySelector('.dropdown-toggle');
      if (dropdownButton) {
        const icon = dropdownButton.querySelector('i')?.cloneNode(true);
        dropdownButton.innerHTML = '';
        if (icon) dropdownButton.appendChild(icon);
        dropdownButton.appendChild(document.createTextNode(` é«˜åº¦é˜ˆå€¼: ${value}`));
      }

      removeAllActiveClasses();
      const map = { "-1":"height-btn1", "0":"height-btn2", "0.325":"height-btn3", "0.625":"height-btn4" };
      const key = String(value);
      if (map[key]) document.getElementById(map[key])?.classList.add('active');

      const hh = document.getElementById('height-hidden');
      if (hh) hh.value = value;
    }

    function selectHeightThreshold(value, buttonId) {
      selectedHeightThreshold = value;
      const dropdownButton = document.querySelector('.dropdown-toggle');
      applyHeightUI(String(value));

      const dropdownMenu = document.querySelector('.dropdown-menu');
      if (dropdownMenu) {
        const bsDropdown = bootstrap.Dropdown.getInstance(dropdownButton);
        if (bsDropdown) bsDropdown.hide();
      }

      const occ = document.getElementById('occ-threshold-hidden')?.value
              || document.getElementById('occ-threshold-slider')?.value
              || '0.60';

      // æ³¨æ„ï¼šè¿™é‡Œåªå¸¦ keyword/height/occ_thresholdã€‚è‹¥ä½ è¿˜æƒ³ä¿ç•™ models/metrics å¤šé€‰ï¼Œ
      // å»ºè®®ä¸è¦ç”¨ window.location.hrefï¼Œè€Œæ˜¯ç›´æ¥æäº¤ formï¼ˆæˆ–æŠŠ models/metrics ä¹Ÿæ‹¼è¿› URLï¼‰ã€‚
      window.location.href =
        `/?height=${encodeURIComponent(value)}&keyword=${encodeURIComponent(keyword_)}&occ_threshold=${encodeURIComponent(occ)}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
      initHeightThresholdButtons();

      const qs = new URLSearchParams(window.location.search);
      const hFromUrl = qs.get('height');

      if (hFromUrl !== null) applyHeightUI(hFromUrl);
      else applyHeightUI("{{ height|default(0, true) }}");
    });
    // ------------------------------------é«˜åº¦é˜ˆå€¼â†‘-------------------------------------------

    // ------------------------------------Occ Threshold æ»‘åŠ¨æ¡â†“-------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
      const slider = document.getElementById('occ-threshold-slider');
      const valueEl = document.getElementById('occ-threshold-midvalue');
      const hidden = document.getElementById('occ-threshold-hidden');

      const qs = new URLSearchParams(window.location.search);
      const fromUrl = qs.get('occ_threshold');

      function setRangeProgress() {
        const min = Number(slider.min);
        const max = Number(slider.max);
        const val = Number(slider.value);
        const p = ((val - min) / (max - min)) * 100;
        slider.style.setProperty('--p', `${p}%`);
      }

      const initVal = Number(fromUrl ?? slider.value ?? 0.6).toFixed(2);
      slider.value = initVal;
      valueEl.textContent = initVal;
      hidden.value = initVal;
      setRangeProgress();

      slider.addEventListener('input', () => {
        const v = Number(slider.value).toFixed(2);
        valueEl.textContent = v;
        hidden.value = v;
        setRangeProgress();
      });
    });
    // ------------------------------------Occ Threshold æ»‘åŠ¨æ¡â†‘-------------------------------------------
  </script>
</body>
</html>
